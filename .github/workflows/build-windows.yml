name: ðŸ—ï¸ Build Windows

on:
    push:
        branches: [main]
        paths:
            - "windows/**"
            - ".github/workflows/build-windows.yml"
    pull_request:
        branches: [main]
        paths:
            - "windows/**"
            - ".github/workflows/build-windows.yml"
    workflow_dispatch:

jobs:
    build:
        runs-on: windows-latest
        timeout-minutes: 30

        env:
            PROJECT_PATH: windows/Screenshotter.Windows/Screenshotter.Windows.csproj
            OUTPUT_PATH: artifacts

        steps:
            - name: ðŸ“¥ Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ðŸ”¢ Calculate Version
              id: version
              shell: pwsh
              run: |
                  $commitCount = git rev-list --count HEAD
                  $version = "1.0.0"

                  Write-Host "Version: $version"
                  Write-Host "Build Number: $commitCount"

                  # Write to job summary
                  "## ðŸ“¦ Build Info" >> $env:GITHUB_STEP_SUMMARY
                  "| Property | Value |" >> $env:GITHUB_STEP_SUMMARY
                  "|----------|-------|" >> $env:GITHUB_STEP_SUMMARY
                  "| **Version** | ``$version`` |" >> $env:GITHUB_STEP_SUMMARY
                  "| **Build Number** | ``$commitCount`` |" >> $env:GITHUB_STEP_SUMMARY
                  "| **Platform** | ``x64`` |" >> $env:GITHUB_STEP_SUMMARY

                  "VERSION=$version" >> $env:GITHUB_OUTPUT
                  "BUILD_NUMBER=$commitCount" >> $env:GITHUB_OUTPUT

            - name: ðŸ› ï¸ Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"
                  dotnet-quality: "preview"

            - name: ðŸ“¦ Restore Dependencies
              run: dotnet restore ${{ env.PROJECT_PATH }} -r win-x64

            - name: ðŸ—ï¸ Build x64
              run: |
                  dotnet build ${{ env.PROJECT_PATH }} `
                    -c Release `
                    -r win-x64 `
                    --no-restore `
                    -p:Platform=x64 `
                    -p:Version=${{ steps.version.outputs.VERSION }} `
                    -p:FileVersion=${{ steps.version.outputs.VERSION }}.${{ steps.version.outputs.BUILD_NUMBER }}

            - name: ðŸ“ Publish x64
              run: |
                  dotnet publish ${{ env.PROJECT_PATH }} `
                    -c Release `
                    -r win-x64 `
                    --no-build `
                    -p:Platform=x64 `
                    -p:PublishSingleFile=false `
                    -o ${{ env.OUTPUT_PATH }}/x64

            - name: ðŸ·ï¸ Set Artifact Name
              id: artifact
              shell: pwsh
              run: |
                  $name = "Screenshotter-Windows-x64-v${{ steps.version.outputs.VERSION }}-${{ steps.version.outputs.BUILD_NUMBER }}"
                  "name=$name" >> $env:GITHUB_OUTPUT

            - name: ðŸ“¤ Upload x64 Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.artifact.outputs.name }}
                  path: ${{ env.OUTPUT_PATH }}/x64/
                  retention-days: 30
